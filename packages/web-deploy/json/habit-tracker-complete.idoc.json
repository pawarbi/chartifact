{
    "$schema": "../../../docs/schema/idoc_v1.json",
    "title": "Complete Habit Tracker",
    "style": {
        "css": [
            "body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f8fafc; }",
            "body { display: grid; grid-template-areas: 'header header' 'controls controls' 'heatmap heatmap' 'habits progress' 'stats stats' 'annual annual' 'debug debug'; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1200px; margin: 0 auto; }",
            "@media (max-width: 768px) { body { grid-template-areas: 'header' 'controls' 'heatmap' 'habits' 'progress' 'stats' 'annual' 'debug'; grid-template-columns: 1fr; } }",
            "[id] { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }",
            "#header { grid-area: header; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; border-radius: 12px; }",
            "#controls { grid-area: controls; }",
            "#heatmap { grid-area: heatmap; }",
            "#habits { grid-area: habits; }",
            "#progress { grid-area: progress; }",
            "#stats { grid-area: stats; }",
            "#annual { grid-area: annual; }",
            "#debug { grid-area: debug; }",
            "h1 { margin: 0; padding: 20px 0; font-size: 2em; font-weight: 600; }",
            "h2 { margin: 0 0 15px 0; font-size: 1.4em; color: #2d3748; font-weight: 600; }",
            "h3 { margin: 0 0 10px 0; font-size: 1.1em; color: #4a5568; font-weight: 500; }",
            ".tabulator { border-radius: 8px; overflow: hidden; }",
            ".tabulator .tabulator-header { background: #f7fafc; }",
            ".tabulator .tabulator-header .tabulator-col { border-right: 1px solid #e2e8f0; }",
            ".tabulator .tabulator-row { border-bottom: 1px solid #f1f5f9; }",
            ".tabulator .tabulator-row:hover { background: #f8fafc; }"
        ]
    },
    "dataLoaders": [
        {
            "dataSourceName": "monthOptions",
            "type": "inline",
            "format": "json",
            "content": [
                {"value": "2024-01", "label": "January 2024"},
                {"value": "2024-02", "label": "February 2024"},
                {"value": "2024-03", "label": "March 2024"}
            ]
        },
        {
            "dataSourceName": "habitsData",
            "type": "inline",
            "format": "json",
            "content": [
                {
                    "habit_name": "Morning Exercise",
                    "category": "Health",
                    "target_frequency": "Daily"
                },
                {
                    "habit_name": "Read for 30min",
                    "category": "Learning",
                    "target_frequency": "Daily"
                },
                {
                    "habit_name": "Meditate",
                    "category": "Wellness",
                    "target_frequency": "Daily"
                },
                {
                    "habit_name": "Write Journal",
                    "category": "Wellness",
                    "target_frequency": "Daily"
                },
                {
                    "habit_name": "Learn New Language",
                    "category": "Learning",
                    "target_frequency": "3x per week"
                },
                {
                    "habit_name": "Call Family",
                    "category": "Social",
                    "target_frequency": "Weekly"
                }
            ]
        },
        {
            "dataSourceName": "progressData",
            "type": "inline",
            "format": "json",
            "content": [
                {"date": "2024-01-15", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-15", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-01-15", "habit_name": "Meditate", "completed": false},
                {"date": "2024-01-16", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-16", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-01-16", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-16", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-01-17", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-17", "habit_name": "Read for 30min", "completed": false},
                {"date": "2024-01-17", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-17", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-01-17", "habit_name": "Learn New Language", "completed": true},
                {"date": "2024-01-18", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-18", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-01-18", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-18", "habit_name": "Call Family", "completed": true},
                {"date": "2024-01-19", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-19", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-01-19", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-19", "habit_name": "Write Journal", "completed": false},
                {"date": "2024-01-19", "habit_name": "Learn New Language", "completed": false},
                {"date": "2024-01-20", "habit_name": "Morning Exercise", "completed": false},
                {"date": "2024-01-20", "habit_name": "Read for 30min", "completed": false},
                {"date": "2024-01-20", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-21", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-22", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-22", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-01-22", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-23", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-23", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-01-24", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-01-24", "habit_name": "Meditate", "completed": false},
                {"date": "2024-01-25", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-01-25", "habit_name": "Learn New Language", "completed": true},
                {"date": "2024-01-26", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-01-26", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-27", "habit_name": "Morning Exercise", "completed": false},
                {"date": "2024-01-27", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-01-28", "habit_name": "Meditate", "completed": true},
                {"date": "2024-01-28", "habit_name": "Call Family", "completed": true},
                {"date": "2024-02-01", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-02-01", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-02-01", "habit_name": "Meditate", "completed": true},
                {"date": "2024-02-02", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-02-02", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-02-02", "habit_name": "Learn New Language", "completed": true},
                {"date": "2024-02-03", "habit_name": "Read for 30min", "completed": false},
                {"date": "2024-02-03", "habit_name": "Meditate", "completed": true},
                {"date": "2024-02-04", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-02-04", "habit_name": "Call Family", "completed": true},
                {"date": "2024-02-05", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-02-05", "habit_name": "Meditate", "completed": true},
                {"date": "2024-02-05", "habit_name": "Write Journal", "completed": false},
                {"date": "2024-02-06", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-02-06", "habit_name": "Learn New Language", "completed": true},
                {"date": "2024-02-07", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-02-07", "habit_name": "Meditate", "completed": true},
                {"date": "2024-02-08", "habit_name": "Morning Exercise", "completed": false},
                {"date": "2024-02-08", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-02-09", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-02-09", "habit_name": "Meditate", "completed": true},
                {"date": "2024-02-10", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-02-10", "habit_name": "Learn New Language", "completed": false},
                {"date": "2024-03-01", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-03-01", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-03-02", "habit_name": "Meditate", "completed": true},
                {"date": "2024-03-02", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-03-03", "habit_name": "Morning Exercise", "completed": false},
                {"date": "2024-03-03", "habit_name": "Learn New Language", "completed": true},
                {"date": "2024-03-04", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-03-04", "habit_name": "Meditate", "completed": true},
                {"date": "2024-03-04", "habit_name": "Call Family", "completed": true},
                {"date": "2024-03-05", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-03-05", "habit_name": "Write Journal", "completed": false},
                {"date": "2024-03-06", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-03-06", "habit_name": "Meditate", "completed": true},
                {"date": "2024-03-07", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-03-07", "habit_name": "Learn New Language", "completed": true},
                {"date": "2024-03-08", "habit_name": "Read for 30min", "completed": false},
                {"date": "2024-03-08", "habit_name": "Write Journal", "completed": true},
                {"date": "2024-03-09", "habit_name": "Morning Exercise", "completed": true},
                {"date": "2024-03-09", "habit_name": "Meditate", "completed": true},
                {"date": "2024-03-10", "habit_name": "Read for 30min", "completed": true},
                {"date": "2024-03-10", "habit_name": "Call Family", "completed": true}
            ]
        }
    ],
    "variables": [
        {
            "variableId": "selectedMonth",
            "type": "string",
            "initialValue": "2024-01"
        },
        {
            "variableId": "filteredProgressData",
            "type": "object",
            "isArray": true,
            "initialValue": [],
            "calculation": {
                "dataSourceNames": ["progressDataTable"],
                "variableDependencies": ["selectedMonth"],
                "dataFrameTransformations": [
                    {
                        "type": "filter",
                        "expr": "slice(datum.date, 0, 7) === selectedMonth"
                    }
                ]
            }
        },
        {
            "variableId": "dailyCompletionData",
            "type": "object",
            "isArray": true,
            "initialValue": [],
            "calculation": {
                "dataSourceNames": ["filteredProgressData"],
                "dataFrameTransformations": [
                    {
                        "type": "formula",
                        "expr": "datum.completed ? 1 : 0",
                        "as": "completed_numeric"
                    },
                    {
                        "type": "aggregate",
                        "groupby": ["date"],
                        "ops": ["sum", "count"],
                        "fields": ["completed_numeric", "completed_numeric"],
                        "as": ["completed_count", "total_habits"]
                    },
                    {
                        "type": "formula",
                        "expr": "datum.completed_count / datum.total_habits",
                        "as": "completion_rate"
                    }
                ]
            }
        },
        {
            "variableId": "annualCompletionData",
            "type": "object",
            "isArray": true,
            "initialValue": [],
            "calculation": {
                "dataSourceNames": ["progressDataTable"],
                "dataFrameTransformations": [
                    {
                        "type": "formula",
                        "expr": "datum.completed ? 1 : 0",
                        "as": "completed_numeric"
                    },
                    {
                        "type": "aggregate",
                        "groupby": ["date"],
                        "ops": ["sum", "count"],
                        "fields": ["completed_numeric", "completed_numeric"],
                        "as": ["completed_count", "total_habits"]
                    },
                    {
                        "type": "formula",
                        "expr": "datum.completed_count / datum.total_habits",
                        "as": "completion_rate"
                    }
                ]
            }
        },
        {
            "variableId": "totalHabits",
            "type": "number",
            "initialValue": 0,
            "calculation": {
                "vegaExpression": "length(data('habitsDataTable'))"
            }
        },
        {
            "variableId": "completionRateData",
            "type": "object",
            "isArray": true,
            "initialValue": [],
            "calculation": {
                "dataSourceNames": ["filteredProgressData"],
                "dataFrameTransformations": [
                    {
                        "type": "formula",
                        "expr": "datum.completed ? 1 : 0",
                        "as": "completed_numeric"
                    },
                    {
                        "type": "aggregate",
                        "ops": ["count", "sum"],
                        "fields": ["completed_numeric", "completed_numeric"],
                        "as": ["total_entries", "completed_count"]
                    },
                    {
                        "type": "formula",
                        "expr": "datum.completed_count / datum.total_entries * 100",
                        "as": "completion_rate"
                    }
                ]
            }
        },
        {
            "variableId": "overallCompletionRate",
            "type": "string",
            "initialValue": "0%",
            "calculation": {
                "vegaExpression": "format(data('completionRateData')[0] ? data('completionRateData')[0].completion_rate : 0, '.1f') + '%'"
            }
        },
        {
            "variableId": "activeDaysData",
            "type": "object",
            "isArray": true,
            "initialValue": [],
            "calculation": {
                "dataSourceNames": ["filteredProgressData"],
                "dataFrameTransformations": [
                    {
                        "type": "aggregate",
                        "groupby": ["date"],
                        "ops": ["count"],
                        "fields": ["habit_name"],
                        "as": ["habits_tracked"]
                    }
                ]
            }
        },
        {
            "variableId": "totalActiveDays",
            "type": "number",
            "initialValue": 0,
            "calculation": {
                "vegaExpression": "length(data('activeDaysData'))"
            }
        },
        {
            "variableId": "totalCompletedEntries",
            "type": "object",
            "isArray": true,
            "initialValue": [],
            "calculation": {
                "dataSourceNames": ["filteredProgressData"],
                "dataFrameTransformations": [
                    {
                        "type": "filter",
                        "expr": "datum.completed === true"
                    },
                    {
                        "type": "aggregate",
                        "ops": ["count"],
                        "fields": ["completed"],
                        "as": ["completed_count"]
                    }
                ]
            }
        },
        {
            "variableId": "totalCompleted",
            "type": "number",
            "initialValue": 0,
            "calculation": {
                "vegaExpression": "data('totalCompletedEntries')[0] ? data('totalCompletedEntries')[0].completed_count : 0"
            }
        },
        {
            "variableId": "enrichedProgressData",
            "type": "object",
            "isArray": true,
            "initialValue": [],
            "calculation": {
                "dataSourceNames": [
                    "progressDataTable"
                ],
                "dataFrameTransformations": [
                    {
                        "type": "lookup",
                        "from": "habitsDataTable",
                        "key": "habit_name",
                        "fields": [
                            "habit_name"
                        ],
                        "values": ["category", "target_frequency"]
                    },
                    {
                        "type": "formula",
                        "expr": "datum.category || 'unknown'",
                        "as": "category"
                    }
                ]
            }
        }
    ],
    "groups": [
        {
            "groupId": "header",
            "elements": [
                "# üéØ Complete Habit Tracker",
                "Track your daily habits with monthly filtering and annual insights for building consistent routines."
            ]
        },
        {
            "groupId": "controls",
            "elements": [
                "## üéõÔ∏è Filters",
                "",
                {
                    "type": "dropdown",
                    "variableId": "selectedMonth",
                    "label": "Select Month:",
                    "dynamicOptions": {
                        "dataSourceName": "monthOptions",
                        "fieldName": "value"
                    }
                }
            ]
        },
        {
            "groupId": "heatmap",
            "elements": [
                "## üóìÔ∏è Monthly Habit Completion",
                {
                    "type": "chart",
                    "chartKey": "monthlyHeatmap"
                }
            ]
        },
        {
            "groupId": "habits",
            "elements": [
                "## üìã My Habits",
                {
                    "type": "tabulator",
                    "dataSourceName": "habitsData",
                    "variableId": "habitsDataTable",
                    "editable": true,
                    "tabulatorOptions": {
                        "columns": [
                            {"field": "habit_name", "title": "Habit", "width": 200, "editor": "input"},
                            {"field": "category", "title": "Category", "width": 120, "editor": "input"},
                            {"field": "target_frequency", "title": "Target", "width": 150, "editor": "input"}
                        ],
                        "layout": "fitColumns",
                        "height": "300px",
                        "rowHeader": {
                            "width": 40,
                            "hozAlign": "center",
                            "formatter": "rownum"
                        }
                    }
                }
            ]
        },
        {
            "groupId": "progress",
            "elements": [
                "## üìà Progress",
                {
                    "type": "tabulator",
                    "dataSourceName": "progressData",
                    "variableId": "progressDataTable",
                    "editable": true,
                    "tabulatorOptions": {
                        "columns": [
                            {"field": "date", "title": "Date", "width": 100, "editor": "date"},
                            {"field": "habit_name", "title": "Habit", "width": 150, "editor": "input"},
                            {"field": "completed", "title": "‚úì", "width": 50, "hozAlign": "center", "formatter": "tickCross", "editor": "tickCross"}
                        ],
                        "layout": "fitColumns",
                        "height": "300px",
                        "initialSort": [
                            {"column": "date", "dir": "desc"}
                        ]
                    }
                }
            ]
        },
        {
            "groupId": "stats",
            "elements": [
                "## üìä Statistics",
                "",
                "**Active Habits:** {{totalHabits}}",
                "",
                "**Completion Rate:** {{overallCompletionRate}}",
                "",
                "**Days Tracked:** {{totalActiveDays}}",
                "",
                "**Total Completed:** {{totalCompleted}} habits"
            ]
        },
        {
            "groupId": "annual",
            "elements": [
                "## üìÖ Annual Calendar View",
                {
                    "type": "chart",
                    "chartKey": "annualHeatmap"
                }
            ]
        },
        {
            "groupId": "debug",
            "elements": [
                "## üîç Debug: Progress with Categories",
                {
                    "type": "tabulator",
                    "dataSourceName": "enrichedProgressData",
                    "tabulatorOptions": {
                        "columns": [
                            {"field": "date", "title": "Date", "width": 100},
                            {"field": "habit_name", "title": "Habit", "width": 150},
                            {"field": "category", "title": "Category", "width": 100},
                            {"field": "completed", "title": "‚úì", "width": 50, "hozAlign": "center", "formatter": "tickCross"}
                        ],
                        "layout": "fitColumns",
                        "height": "200px",
                        "initialSort": [
                            {"column": "date", "dir": "desc"}
                        ]
                    }
                }
            ]
        }
    ],
    "resources": {
        "charts": {
            "monthlyHeatmap": {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"name": "filteredProgressData"},
                "title": "Daily Habit Completion Rate for Selected Month",
                "config": {
                    "view": {
                        "strokeWidth": 0,
                        "step": 13
                    },
                    "axis": {
                        "domain": false
                    }
                },
                "mark": "rect",
                "transform": [
                    {"calculate": "datum.completed ? 1 : 0", "as": "completed_numeric"}
                ],
                "encoding": {
                    "x": {
                        "field": "date",
                        "timeUnit": "date",
                        "type": "ordinal",
                        "title": "Day",
                        "axis": {
                            "labelAngle": 0,
                            "format": "%e"
                        },
                        "scale": {
                            "domain": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31]
                        }
                    },
                    "color": {
                        "field": "completed_numeric",
                        "aggregate": "mean",
                        "type": "quantitative",
                        "scale": {
                            "scheme": "greens",
                            "domain": [0, 1]
                        },
                        "legend": {
                            "title": "Completion Rate",
                            "format": ".0%"
                        }
                    },
                    "tooltip": [
                        {"field": "date", "type": "temporal", "title": "Date"},
                        {"field": "completed_numeric", "aggregate": "mean", "type": "quantitative", "title": "Completion Rate", "format": ".1%"}
                    ]
                },
                "width": "container",
                "height": 100
            },
            "annualHeatmap": {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"name": "progressDataTable"},
                "title": "Annual Habit Completion Overview",
                "config": {
                    "view": {
                        "strokeWidth": 0,
                        "step": 13
                    },
                    "axis": {
                        "domain": false
                    }
                },
                "mark": "rect",
                "transform": [
                    {"calculate": "datum.completed ? 1 : 0", "as": "completed_numeric"}
                ],
                "encoding": {
                    "x": {
                        "field": "date",
                        "timeUnit": "date",
                        "type": "ordinal",
                        "title": "Day",
                        "axis": {
                            "labelAngle": 0,
                            "format": "%e"
                        },
                        "scale": {
                            "domain": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31]
                        }
                    },
                    "y": {
                        "field": "date",
                        "timeUnit": "month",
                        "type": "ordinal",
                        "title": "Month"
                    },
                    "color": {
                        "field": "completed_numeric",
                        "aggregate": "mean",
                        "type": "quantitative",
                        "scale": {
                            "scheme": "blues",
                            "domain": [0, 1]
                        },
                        "legend": {
                            "title": "Completion Rate",
                            "format": ".0%"
                        }
                    },
                    "tooltip": [
                        {"field": "date", "type": "temporal", "title": "Date"},
                        {"field": "completed_numeric", "aggregate": "mean", "type": "quantitative", "title": "Completion Rate", "format": ".1%"}
                    ]
                },
                "width": "container",
                "height": 150
            }
        }
    }
}